# 后端服务集群（upstream: dcp）
# - 作用：将前端或代理请求转发到实际的 dcp 应用实例（监听端口 8099）
# - 负载均衡策略使用 nginx 默认的轮询（如需可改为 least_conn 等）
upstream dcp {
    server 10.64.8.94:8099;  # 节点1（10.64.8.94:8099）
    server 10.64.8.95:8099;  # 节点2（10.64.8.95:8099）
    server 10.64.8.96:8099;  # 节点3（10.64.8.96:8099）
}

# XXL-Job 调度后台集群（upstream: xxljob）
# - 提供任务调度访问（监听端口 9091），用于 /fr_schedule 等路径的代理转发
upstream xxljob {
    server 10.64.8.94:9091;  # XXL-Job 节点1（10.64.8.94:9091）
    server 10.64.8.95:9091;  # XXL-Job 节点2（10.64.8.95:9091）
    server 10.64.8.96:9091;  # XXL-Job 节点3（10.64.8.96:9091）
}

# Flink JobManager UI/REST 集群（upstream: flink_jobmanagers）
# - 用于代理 Flink Web UI / REST 请求（默认端口 8080）
upstream flink_jobmanagers {
    server 10.64.8.88:8080;  # JobManager 节点1（10.64.8.88:8080）
    server 10.64.8.89:8080;  # JobManager 节点2（10.64.8.89:8080）
}

server {
    listen 9011;                    # 监听端口（仅供内部访问）
    server_name 10.64.8.97;         # 本机标识（建议在生产环境中使用域名）
    access_log /dcpdata/nginx/logs/dcp_access.log;  # 访问日志
    error_log /dcpdata/nginx/logs/dcp_err.log;      # 错误日志
    root /dcpdata/nginx/html/dcp/;  # 静态资源根目录（用于默认 / 路径）
    index index.html;
	
	
		location / {
        # 前端单页应用（SPA）根路径：优先返回静态资源，找不到时回退到 /index.html
        index index.html index.htm;
        try_files $uri /index.html;
    }
  		location /_data {
    		# 将 /_data/* 请求代理到后端 dcp 服务（去除前缀后转发）
    		# rewrite 会把 "/_data/xxx" 重写为 "/xxx" 后发往 upstream dcp
    		rewrite  ^/_data/?(.*)$ /$1 break;               # 修复：确保以斜杠开头进行匹配
    		# uwsgi_params 包含 uWSGI 所需的常用参数；若后端为 HTTP 服务可根据情况调整
    		include  uwsgi_params;
    		proxy_pass  http://dcp/;     # 转发到 upstream dcp
		proxy_read_timeout 180s;      # 读超时（适配慢请求）
    		client_max_body_size    1024m; # 支持较大文件上传（1GB）
    	}

    location /flink/ {
        # 代理 Flink Web UI（支持 WebSocket 与 REST）
        # 将 /flink/* 去掉前缀后转发到 flink_jobmanagers upstream
        rewrite ^/flink/(.*)$ /$1 break;      # 适配 flink 默认根目录
        proxy_pass http://flink_jobmanagers;  # 代理到 Flink JobManager 集群

        # 支持 WebSocket（Flink UI 依赖 WebSocket）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;   # 升级协议请求头（WebSocket）
        proxy_set_header Connection "upgrade";  # 保持连接升级

        # 传递客户端与协议信息，便于后端记录真实来源与生成正确跳转链接
        proxy_set_header Host $host;                         # 保留原始 Host
        proxy_set_header X-Real-IP $remote_addr;             # 客户端真实 IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 代理链路
        proxy_set_header X-Forwarded-Proto $scheme;          # 原始请求协议（http/https）

        # 超时设置（适应慢请求或长轮询）
        proxy_connect_timeout 60s;   # 连接超时
        proxy_read_timeout 300s;     # 读取超时
        proxy_send_timeout 300s;     # 发送超时

        # 禁用 proxy 重定向，保持原始 Location 头透传给客户端
        proxy_redirect off;
    }
		


# XXL-Job 的前端/调度请求入口，直接代理到 xxljob upstream 的 /fr_schedule 路径
    location ^~/fr_schedule {
        proxy_pass http://xxljob/fr_schedule;

        # 传递客户端与协议信息，便于后端记录真实来源与生成正确跳转链接
        proxy_set_header Host $host;                          # 保留原始 Host
        proxy_set_header X-Real-IP $remote_addr;              # 客户端真实 IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 代理链路
        proxy_set_header X-Forwarded-Proto $scheme;           # 原始请求协议（http/https）

        # 超时设置（适应慢请求或长轮询）
        proxy_connect_timeout 60s;    # 连接超时
        proxy_read_timeout 300s;      # 读取超时
        proxy_send_timeout 300s;      # 发送超时

        # 禁用 proxy 重定向，保持原始 Location 头透传给客户端
        proxy_redirect off;
    }
			# 针对不同机器的 druid 管理界面做直连转发（分别映射到对应后端的 /druid 路径）
    location ^~/druid-94 {
        proxy_pass http://10.64.8.94:8099/druid;

        # 传递客户端与协议信息，便于后端记录真实来源与生成正确跳转链接
        proxy_set_header Host $host;                          # 保留原始 Host
        proxy_set_header X-Real-IP $remote_addr;              # 客户端真实 IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 代理链路
        proxy_set_header X-Forwarded-Proto $scheme;           # 原始请求协议（http/https）

        # 超时设置（适应慢请求或长轮询）
        proxy_connect_timeout 60s;    # 连接超时
        proxy_read_timeout 300s;      # 读取超时
        proxy_send_timeout 300s;      # 发送超时

        # 禁用 proxy 重定向，保持原始 Location 头透传给客户端
        proxy_redirect off;
    }

    # druid 对应到 95
    location ^~/druid-95 {
        proxy_pass http://10.64.8.95:8099/druid;

        # 传递客户端与协议信息，便于后端记录真实来源与生成正确跳转链接
        proxy_set_header Host $host;                          # 保留原始 Host
        proxy_set_header X-Real-IP $remote_addr;              # 客户端真实 IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 代理链路
        proxy_set_header X-Forwarded-Proto $scheme;           # 原始请求协议（http/https）

        # 超时设置（适应慢请求或长轮询）
        proxy_connect_timeout 60s;    # 连接超时
        proxy_read_timeout 300s;      # 读取超时
        proxy_send_timeout 300s;      # 发送超时

        # 禁用 proxy 重定向，保持原始 Location 头透传给客户端
        proxy_redirect off;
    }

    # druid 对应到 96
    location ^~/druid-96 {
        proxy_pass http://10.64.8.96:8099/druid;

        # 传递客户端与协议信息，便于后端记录真实来源与生成正确跳转链接
        proxy_set_header Host $host;                          # 保留原始 Host
        proxy_set_header X-Real-IP $remote_addr;              # 客户端真实 IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 代理链路
        proxy_set_header X-Forwarded-Proto $scheme;           # 原始请求协议（http/https）

        # 超时设置（适应慢请求或长轮询）
        proxy_connect_timeout 60s;    # 连接超时
        proxy_read_timeout 300s;      # 读取超时
        proxy_send_timeout 300s;      # 发送超时

        # 禁用 proxy 重定向，保持原始 Location 头透传给客户端
        proxy_redirect off;
    }
# 自定义 50x 错误页面，便于在发生服务器错误时返回统一提示
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root html;
    }

}
