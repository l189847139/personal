################################################################################
# Redis 配置文件（已添加注释与分节）
# 说明：本文件保留了现有配置值，仅增加注释以便阅读与运维。修改敏感项（如密码）请先备份并限制文件权限。
# 建议：生产环境中将此文件权限设置为 600，并确保数据目录与日志目录权限正确。
#   示例：chmod 600 /path/to/redis.conf && chown redis:redis /data/redis/sentry -R
################################################################################

################################## 网络设置 ###################################
# bind：默认注释表示监听所有可用接口；可根据安全策略限定具体 IP。
# bind 192.168.1.100 10.0.0.1     # 监听两个指定 IPv4 地址
# bind 127.0.0.1 ::1              # 同时监听 IPv4 与 IPv6 回环
# bind * -::*                     # 监听所有接口
#bind 127.0.0.1 -::1
# 关闭受保护模式以允许外网访问（仅在内部网络或已有防火墙时推荐）
protected-mode no
# 服务端口
port 6379
# 客户端连接超时（秒），超过该时间未活跃将关闭连接
timeout 300
# TCP keepalive（秒），用于维护空闲连接的健康
tcp-keepalive 300
# tcp-backlog：设置 TCP 半连接队列长度，适当提高以应对高并发连接（示例：511）
tcp-backlog 511

############################## TLS/SSL（按需启用） ############################
# 本文件未启用 TLS；如需启用，请配置 tls-cert-file / tls-key-file 等参数。

################################# 常规设置 ####################################
# 是否以守护进程方式运行（后台）
daemonize yes
# 进程 PID 文件路径（请确认目录存在并权限正确）
pidfile "/data/redis/sentry/pid/redis-server-6379.pid"
# 日志级别（debug, verbose, notice, warning）
loglevel notice
# 日志文件路径
logfile "/data/redis/sentry/logs/redis-server_6379.log"
# 数据库数量（逻辑数据库）
databases 16
# 是否显示启动 logo
always-show-logo no
# 是否设置进程名以便 ps 等命令识别
set-proc-title yes
proc-title-template "{title} {listen-addr} {server-mode}"
locale-collate ""
# supervised：如果通过 systemd 启动，建议设置为 systemd（便于进程管理与自动重启）
supervised systemd

############################### RDB 快照（持久化） ############################
# save <seconds> <changes>：在指定秒数内如果有指定次数的写操作则生成 RDB 快照
save 900 100000
save 300 10000000
save 60 1000000
# 如果 BGSAVE 失败是否停止写操作（默认 yes，推荐在生产保留）
stop-writes-on-bgsave-error yes
# 是否压缩 RDB 文件
rdbcompression yes
# 是否校验 RDB 文件（提高安全性）
rdbchecksum yes
# RDB 文件名
dbfilename "dump_6379.rdb"
# 在复制场景中是否删除同步产生的临时文件
rdb-del-sync-files no
# RDB 工作目录（请确认目录存在且磁盘足够）
dir "/data/redis/sentry/dump"

############################### 主/从（复制）配置 ###############################
# masterauth：如果主节点有密码，replica 需要此密码来进行认证（保密）
masterauth "dfredis2024zq"
# replica-serve-stale-data：当主不可用时从节点是否仍允许读取（yes: 允许读取）
replica-serve-stale-data yes
# replica-read-only：是否将从节点设为只读（通常为 yes，以避免写操作在从节点发生）
replica-read-only yes
# diskless 同步设置：减少磁盘 IO、加快同步速度，但可能占用更多内存
repl-diskless-sync yes
# repl-diskless-sync-delay：diskless 同步开始前等待的秒数（用于等待更多 replica 准备）
repl-diskless-sync-delay 5
# repl-diskless-sync-max-replicas：diskless 模式下允许并行的最大 replica 数，0 表示不限制
repl-diskless-sync-max-replicas 0
# repl-diskless-load：diskless 模式下的加载策略（disabled/yes），通常保留为 disabled
repl-diskless-load disabled
# repl-disable-tcp-nodelay：是否禁用 TCP_NODELAY（no 保持低延迟）
repl-disable-tcp-nodelay no
# replica-priority：从节点优先级，值越小越不容易被选为主节点（0 表示绝对不会被选为主）
replica-priority 100
# min-replicas-to-write / min-replicas-max-lag：写入安全设置，保证在有足够健康 replica 时才允许写入
# 示例：至少 1 个 replica 且最大延迟不超过 10 秒时允许写入
min-replicas-to-write 1
min-replicas-max-lag 10

############################## 键追踪 / 事件相关 #############################
# 可根据需要开启 notify-keyspace-events 来接收键事件通知（如过期、删除等）
notify-keyspace-events ""

################################## 安全配置 ##################################
# ACL 日志最大长度
acllog-max-len 128
# requirepass：客户端访问密码（明文保存在配置文件中，注意权限）
requirepass "dfredis2024zq"
# 建议重命名或禁用高风险命令以防误操作或滥用（示例：禁用 FLUSHDB，重命名 CONFIG）
# 取消注释并调整下列行以启用：
# rename-command FLUSHDB ""
# rename-command CONFIG "CONFIG_RENAME"
# 请根据你的运维策略启用上面示例
# 建议：将配置文件权限设置为 600 并仅允许运维账户读取
#   chmod 600 /path/to/redis.conf

################################### 客户端 ###################################
# 最大并发客户端连接数
maxclients 20000

############################### 内存与淘汰策略 ################################
# 最大内存限制（示例：4gb），达到后根据 maxmemory-policy 进行处理（未显式设置则使用默认）
maxmemory 4gb
# maxmemory-policy：内存达到限制时的淘汰策略（例如 volatile-lru / allkeys-lru / noeviction）
# 建议：若多数 key 设置了过期策略可选用 volatile-lru；若需要自动淘汰任意 key 可选 allkeys-lru
maxmemory-policy volatile-lru
# maxmemory-samples：LRU 近似采样数，数值越大淘汰选择越准确但会带来更多 CPU 开销
maxmemory-samples 10

############################### 懒释放相关 ###################################
# lazyfree-lazy-* 参数控制是否使用后台异步释放内存，能避免主线程阻塞但会延迟释放内存
# 当需要在高负载下避免阻塞时可设置为 yes（需评估内存与后台线程影响）
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
# replica-lazy-flush：在大量数据同步或重写时，是否让从端延迟刷新（no 表示即时刷新）
replica-lazy-flush no
lazyfree-lazy-user-del no
lazyfree-lazy-user-flush no

############################# 内核与 OOM 控制 ################################
oom-score-adj no
oom-score-adj-values 0 200 800

####################### transparent hugepage (THP) 控制 ######################
disable-thp yes

############################ AOF（追加日志） ################################
appendonly no
appendfilename "appendonly.aof"
appenddirname "appendonlydir"
# appendfsync 策略：always / everysec / no；everysec 在性能与持久性间折中
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes
aof-timestamp-enabled no

############################# 运行时与性能调优 ###############################
# active-expire-effort：主动过期键的清理强度（0-100），值越高清理更积极但占用更多 CPU，默认 1
active-expire-effort 5
busy-reply-threshold 5000
slowlog-log-slower-than 10000
slowlog-max-len 1000
latency-monitor-threshold 0
# latency-tracking：启用后记录延迟事件（按需开启以节省开销）
# latency-tracking yes
# latency-tracking-info-percentiles 可用于调整记录的分位点（已生成）

############################ 高级内部配置（通常使用默认值） ##################
hash-max-listpack-entries 512
hash-max-listpack-value 64
list-max-listpack-size -2
list-compress-depth 0
set-max-intset-entries 512
set-max-listpack-entries 128
set-max-listpack-value 64
zset-max-listpack-entries 128
zset-max-listpack-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4kb
stream-node-max-entries 100
activerehashing yes

# 客户端输出缓冲区限制：<类> <hard> <soft> <soft_seconds>
# 说明：合理设置可防止缓冲区无限增长导致 OOM 或阻塞
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60
# 事件循环频率（hz）：影响内部任务调度与延迟，数值越大调度越频繁但 CPU 消耗增大
hz 10
# dynamic-hz：自动调整 hz 以在性能与延迟间取得平衡
dynamic-hz yes
# aof-rewrite-incremental-fsync：在 AOF 重写过程中使用增量 fsync，可降低 I/O 峰值
aof-rewrite-incremental-fsync yes
# rdb-save-incremental-fsync：RDB 保存时使用增量 fsync，增加持久化安全性
rdb-save-incremental-fsync yes

# 未启用的示例设置：可按需打开
# client-query-buffer-limit 1gb
# maxmemory-clients 5%
# proto-max-bulk-len 512mb
# lfu-log-factor 10
# lfu-decay-time 1

######################### 主动碎片整理 ####################################
jemalloc-bg-thread yes